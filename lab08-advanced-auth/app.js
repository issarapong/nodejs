/**
 * App.js - Advanced Authentication Lab
 * ‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡πà‡∏ô Node.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Advanced Authentication & Authorization
 */

const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const compression = require('compression');
const session = require('express-session');
const passport = require('passport');
require('dotenv').config();

// Database
const database = require('./config/database');

// Routes
const authRoutes = require('./routes/auth');

// Middleware
const rateLimitMiddleware = require('./middleware/rateLimit');

// Services
const emailService = require('./services/emailService');

// Create Express app
const app = express();
const PORT = process.env.PORT || 3000;

// ===========================================
// Global Middleware
// ===========================================

// Security Headers
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", 'https://fonts.googleapis.com'],
      fontSrc: ["'self'", 'https://fonts.gstatic.com'],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", 'data:', 'https:'],
      connectSrc: ["'self'"]
    }
  },
  crossOriginEmbedderPolicy: false
}));

// CORS Configuration
const corsOptions = {
  origin: function (origin, callback) {
    const allowedOrigins = (process.env.ALLOWED_ORIGINS || 'http://localhost:3000,http://localhost:3001').split(',');
    
    // Allow requests with no origin (mobile apps, Postman, etc.)
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Refresh-Token']
};

app.use(cors(corsOptions));

// Body parsing
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Compression
app.use(compression());

// Logging
if (process.env.NODE_ENV !== 'test') {
  app.use(morgan(':remote-addr - :remote-user [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent" - :response-time ms'));
}

// Session Configuration
app.use(session({
  secret: process.env.SESSION_SECRET || 'your-session-secret-key-here-make-it-secure',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    maxAge: 10 * 60 * 1000 // 10 minutes for temp tokens
  },
  name: 'lab8.sid' // ‡∏ä‡∏∑‡πà‡∏≠ session cookie
}));

// Passport Initialization
app.use(passport.initialize());
app.use(passport.session());

// Global Rate Limiting
app.use('/api', rateLimitMiddleware.general());

// Request Info Middleware
app.use((req, res, next) => {
  req.timestamp = Date.now();
  req.requestId = require('crypto').randomBytes(8).toString('hex');
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÅ‡∏•‡∏∞ User Agent
  req.clientInfo = {
    ip: req.ip || req.connection.remoteAddress,
    userAgent: req.get('User-Agent'),
    timestamp: new Date().toISOString()
  };
  
  next();
});

// ===========================================
// Routes
// ===========================================

/**
 * @route   GET /
 * @desc    Home Page / API Info
 * @access  Public
 */
app.get('/', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'NodeJS Lab 8 - Advanced Authentication & Authorization API',
    version: '1.0.0',
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString(),
    endpoints: {
      auth: '/api/auth',
      health: '/api/auth/health',
      docs: '/api/docs'
    },
    features: [
      'JWT Authentication with Access & Refresh Tokens',
      'Multi-Factor Authentication (MFA)',
      'OAuth 2.0 (Google, Facebook)',
      'Role-Based Access Control (RBAC)',
      'Device Management',
      'Rate Limiting & Security',
      'Email Notifications',
      'Password Security'
    ]
  });
});

/**
 * Authentication Routes
 */
app.use('/api/auth', authRoutes);

/**
 * @route   GET /api/docs
 * @desc    API Documentation
 * @access  Public
 */
app.get('/api/docs', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'API Documentation - NodeJS Lab 8',
    baseURL: `${req.protocol}://${req.get('host')}/api`,
    authentication: {
      type: 'Bearer Token',
      header: 'Authorization: Bearer <access_token>',
      refreshToken: 'Use /api/auth/refresh endpoint'
    },
    endpoints: {
      public: {
        'POST /auth/register': '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å',
        'POST /auth/login': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        'POST /auth/refresh': '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ Access Token',
        'POST /auth/forgot-password': '‡∏Ç‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
        'POST /auth/reset-password': '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
        'GET /auth/verify-email/:token': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•',
        'GET /auth/google': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google',
        'GET /auth/facebook': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Facebook'
      },
      private: {
        'GET /auth/profile': '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå',
        'POST /auth/logout': '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        'POST /auth/change-password': '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô',
        'GET /auth/devices': '‡∏î‡∏π‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        'POST /auth/mfa/enable': '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô MFA',
        'POST /auth/mfa/verify-setup': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MFA'
      }
    },
    examples: {
      register: {
        method: 'POST',
        url: '/api/auth/register',
        body: {
          username: 'testuser',
          email: 'test@example.com',
          password: 'Password123!',
          firstName: '‡∏ä‡∏∑‡πà‡∏≠',
          lastName: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'
        }
      },
      login: {
        method: 'POST',
        url: '/api/auth/login',
        body: {
          email: 'test@example.com',
          password: 'Password123!'
        }
      }
    }
  });
});

/**
 * @route   GET /api/health
 * @desc    Health Check
 * @access  Public
 */
app.get('/api/health', async (req, res) => {
  try {
    const dbStats = await database.getStats();
    const uptime = process.uptime();
    const memoryUsage = process.memoryUsage();
    
    res.status(200).json({
      success: true,
      message: 'API is healthy',
      timestamp: new Date().toISOString(),
      uptime: {
        seconds: uptime,
        human: `${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m ${Math.floor(uptime % 60)}s`
      },
      database: dbStats,
      memory: {
        rss: `${Math.round(memoryUsage.rss / 1024 / 1024)} MB`,
        heapTotal: `${Math.round(memoryUsage.heapTotal / 1024 / 1024)} MB`,
        heapUsed: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)} MB`
      },
      environment: process.env.NODE_ENV || 'development',
      version: '1.0.0'
    });
  } catch (error) {
    res.status(503).json({
      success: false,
      message: 'Service temporarily unavailable',
      error: error.message
    });
  }
});

// ===========================================
// Error Handling Middleware
// ===========================================

/**
 * 404 Handler
 */
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á API ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    requestedPath: req.originalUrl,
    method: req.method,
    suggestions: [
      '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞ HTTP method',
      '‡∏î‡∏π API documentation ‡∏ó‡∏µ‡πà /api/docs',
      '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà /api prefix ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á'
    ]
  });
});

/**
 * Global Error Handler
 */
app.use((error, req, res, next) => {
  // Log error details
  console.error('üö® Global Error Handler:');
  console.error('Request ID:', req.requestId);
  console.error('Path:', req.originalUrl);
  console.error('Method:', req.method);
  console.error('Error:', error);
  
  // CORS Error
  if (error.message === 'Not allowed by CORS') {
    return res.status(403).json({
      success: false,
      message: 'CORS policy violation',
      code: 'CORS_ERROR'
    });
  }
  
  // JWT Error
  if (error.name === 'JsonWebTokenError') {
    return res.status(401).json({
      success: false,
      message: 'Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      code: 'INVALID_TOKEN'
    });
  }
  
  if (error.name === 'TokenExpiredError') {
    return res.status(401).json({
      success: false,
      message: 'Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏',
      code: 'TOKEN_EXPIRED'
    });
  }
  
  // Validation Error
  if (error.name === 'ValidationError') {
    const errors = Object.values(error.errors).map(err => ({
      field: err.path,
      message: err.message
    }));
    
    return res.status(400).json({
      success: false,
      message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      code: 'VALIDATION_ERROR',
      errors
    });
  }
  
  // MongoDB Duplicate Key Error
  if (error.code === 11000) {
    const field = Object.keys(error.keyPattern)[0];
    return res.status(409).json({
      success: false,
      message: `${field} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß`,
      code: 'DUPLICATE_ERROR'
    });
  }
  
  // Cast Error (Invalid ObjectId)
  if (error.name === 'CastError') {
    return res.status(400).json({
      success: false,
      message: 'ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      code: 'INVALID_ID'
    });
  }
  
  // Rate Limit Error
  if (error.status === 429) {
    return res.status(429).json({
      success: false,
      message: '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á',
      code: 'RATE_LIMIT_EXCEEDED'
    });
  }
  
  // Default Error Response
  const statusCode = error.statusCode || error.status || 500;
  const message = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå';
  
  res.status(statusCode).json({
    success: false,
    message,
    code: error.code || 'INTERNAL_ERROR',
    requestId: req.requestId,
    ...(process.env.NODE_ENV === 'development' && {
      stack: error.stack,
      details: error
    })
  });
});

// ===========================================
// Server Initialization
// ===========================================

/**
 * Start Server
 */
async function startServer() {
  try {
    console.log('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô NodeJS Lab 8 - Advanced Authentication...\n');
    
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    await database.connect();
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    const server = app.listen(PORT, () => {
      console.log('\nüéâ ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');
      console.log('üìç URL:', `http://localhost:${PORT}`);
      console.log('üîê API:', `http://localhost:${PORT}/api/auth`);
      console.log('üìö Docs:', `http://localhost:${PORT}/api/docs`);
      console.log('üè• Health:', `http://localhost:${PORT}/api/health`);
      console.log('üåç Environment:', process.env.NODE_ENV || 'development');
      console.log('‚è∞ Started at:', new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }));
      console.log('\nüìã Available Features:');
      console.log('  ‚úÖ JWT Authentication (Access & Refresh Tokens)');
      console.log('  ‚úÖ Multi-Factor Authentication (MFA)');
      console.log('  ‚úÖ OAuth 2.0 (Google, Facebook)');
      console.log('  ‚úÖ Role-Based Access Control');
      console.log('  ‚úÖ Device Management');
      console.log('  ‚úÖ Rate Limiting & Security');
      console.log('  ‚úÖ Email Notifications');
      console.log('  ‚úÖ Password Security');
      console.log('\nüîß Environment Variables:');
      console.log(`  üìß Email Service: ${process.env.EMAIL_HOST ? '‚úÖ' : '‚ùå'}`);
      console.log(`  üîë JWT Secrets: ${process.env.JWT_ACCESS_SECRET ? '‚úÖ' : '‚ùå'}`);
      console.log(`  üåê OAuth Google: ${process.env.GOOGLE_CLIENT_ID ? '‚úÖ' : '‚ùå'}`);
      console.log(`  üìò OAuth Facebook: ${process.env.FACEBOOK_APP_ID ? '‚úÖ' : '‚ùå'}`);
      console.log('\nüìñ Next Steps:');
      console.log('  1. Copy .env.example to .env and configure');
      console.log('  2. Run: npm run seed (to create sample data)');
      console.log('  3. Test APIs with Postman or curl');
      console.log('  4. Check /api/docs for complete API reference');
      console.log('\n' + '='.repeat(50));
    });
    
    // Graceful shutdown
    process.on('SIGTERM', async () => {
      console.log('\nüõë Received SIGTERM, shutting down gracefully...');
      server.close(async () => {
        await database.disconnect();
        console.log('üëã Server closed');
        process.exit(0);
      });
    });
    
    return server;
    
  } catch (error) {
    console.error('üí• Failed to start server:', error);
    process.exit(1);
  }
}

// Start server only if this file is run directly
if (require.main === module) {
  startServer();
}

module.exports = app;